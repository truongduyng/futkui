<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head', { title, description: 'Admin portal for FutKui' }) %>
    <style>
      body {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }
      .card {
        animation: slideUp 0.4s ease-out;
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #9333ea;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 0.8s linear infinite;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="card w-full max-w-md mx-4 p-8 bg-white rounded-xl shadow-2xl">
      <!-- Logo/Header -->
      <div class="text-center mb-8">
        <div
          class="inline-flex items-center justify-center w-16 h-16 bg-purple-600 rounded-full mb-4"
        >
          <svg
            class="w-8 h-8 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
            ></path>
          </svg>
        </div>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">FutKui Admin</h1>
        <p class="text-gray-600">Sign in with your admin email</p>
      </div>

      <div id="auth-container">
        <!-- Email Form -->
        <form id="email-form" class="space-y-4">
          <div>
            <label
              for="email"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Email Address</label
            >
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition-all"
              placeholder="admin@futkui.com"
              autocomplete="email"
            />
          </div>
          <button
            type="submit"
            id="email-submit-btn"
            class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 focus:ring-4 focus:ring-purple-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Send Magic Code
          </button>
        </form>

        <!-- Code Form -->
        <form id="code-form" class="space-y-4" style="display: none">
          <div class="text-center mb-4">
            <p class="text-sm text-gray-600">We sent a code to</p>
            <p id="sent-email" class="font-semibold text-gray-800"></p>
          </div>
          <div>
            <label
              for="code"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Enter 6-digit Code</label
            >
            <input
              type="text"
              id="code"
              name="code"
              required
              class="w-full px-4 py-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none text-center text-3xl tracking-[0.5em] font-mono transition-all"
              placeholder="••••••"
              maxlength="6"
              pattern="[0-9]{6}"
              inputmode="numeric"
              autocomplete="one-time-code"
            />
          </div>
          <button
            type="submit"
            id="code-submit-btn"
            class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 focus:ring-4 focus:ring-purple-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Verify Code
          </button>
          <button
            type="button"
            id="back-btn"
            class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-200 transition-all"
          >
            ← Use Different Email
          </button>
        </form>

        <!-- Messages -->
        <div
          id="error-message"
          class="mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg flex items-start"
          style="display: none"
        >
          <svg
            class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <span id="error-text"></span>
        </div>
        <div
          id="success-message"
          class="mt-4 p-4 bg-green-50 border border-green-200 text-green-700 rounded-lg flex items-start"
          style="display: none"
        >
          <svg
            class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <span id="success-text"></span>
        </div>
      </div>
    </div>

    <script type="module">
      import { init } from "https://cdn.jsdelivr.net/npm/@instantdb/core@^0.14/+esm";

      const APP_ID = "<%= appId %>";
      const db = init({ appId: APP_ID });

      const emailForm = document.getElementById("email-form");
      const codeForm = document.getElementById("code-form");
      const emailInput = document.getElementById("email");
      const codeInput = document.getElementById("code");
      const backBtn = document.getElementById("back-btn");
      const errorMessage = document.getElementById("error-message");
      const successMessage = document.getElementById("success-message");
      const errorText = document.getElementById("error-text");
      const successText = document.getElementById("success-text");
      const sentEmailDisplay = document.getElementById("sent-email");
      const emailSubmitBtn = document.getElementById("email-submit-btn");
      const codeSubmitBtn = document.getElementById("code-submit-btn");

      let sentEmail = "";

      function showError(message) {
        errorText.textContent = message;
        errorMessage.style.display = "flex";
        successMessage.style.display = "none";
      }

      function showSuccess(message) {
        successText.textContent = message;
        successMessage.style.display = "flex";
        errorMessage.style.display = "none";
      }

      function hideMessages() {
        errorMessage.style.display = "none";
        successMessage.style.display = "none";
      }

      function setLoading(button, isLoading) {
        if (isLoading) {
          button.disabled = true;
          button.innerHTML = '<span class="spinner"></span>Processing...';
        } else {
          button.disabled = false;
        }
      }

      emailForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideMessages();

        const email = emailInput.value.trim();
        if (!email) {
          showError("Please enter your email");
          return;
        }

        setLoading(emailSubmitBtn, true);

        try {
          await db.auth.sendMagicCode({ email });
          sentEmail = email;
          sentEmailDisplay.textContent = email;
          emailForm.style.display = "none";
          codeForm.style.display = "block";
          showSuccess(`Code sent successfully! Check your email.`);
          codeInput.focus();
        } catch (error) {
          showError("Failed to send code. Please try again.");
          console.error(error);
        } finally {
          emailSubmitBtn.disabled = false;
          emailSubmitBtn.textContent = "Send Magic Code";
        }
      });

      codeForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideMessages();

        const code = codeInput.value.trim();
        if (!code) {
          showError("Please enter the code");
          return;
        }

        if (code.length !== 6) {
          showError("Code must be 6 digits");
          return;
        }

        setLoading(codeSubmitBtn, true);

        try {
          const result = await db.auth.signInWithMagicCode({
            email: sentEmail,
            code,
          });
          showSuccess("Success! Verifying admin access...");

          // Get token from the sign-in result
          const token = result.user.refresh_token;

          // Set token in cookie
          document.cookie = `admin_token=${token}; path=/; max-age=2592000; SameSite=Lax`;

          // Small delay to ensure cookie is set
          setTimeout(() => {
            window.location.href = "/admin/dashboard";
          }, 500);
        } catch (error) {
          showError("Invalid code. Please check and try again.");
          console.error(error);
          codeSubmitBtn.disabled = false;
          codeSubmitBtn.textContent = "Verify Code";
        }
      });

      backBtn.addEventListener("click", () => {
        hideMessages();
        codeForm.style.display = "none";
        emailForm.style.display = "block";
        codeInput.value = "";
        sentEmail = "";
        sentEmailDisplay.textContent = "";
      });

      // Auto-format code input (only allow numbers)
      codeInput.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, "");
      });
    </script>
  </body>
</html>
